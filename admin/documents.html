<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Qu·∫£n l√Ω t√†i li·ªáu - DocShare">
    <title>Qu·∫£n l√Ω t√†i li·ªáu - Admin - DocShare</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i...</p>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <span id="toastMessage"></span>
        <button onclick="closeToast()" class="toast-close">&times;</button>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="../index.html" style="text-decoration: none; color: inherit;">
                    <h1>üìö DocShare - Admin</h1>
                </a>
                <span class="logo-subtitle">Qu·∫£n tr·ªã h·ªá th·ªëng</span>
            </div>
            <nav class="nav">
                <a href="./dashboard.html" class="nav-link">
                    <span class="nav-icon">üéõÔ∏è</span>
                    Dashboard
                </a>
                <a href="./users.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    Ng∆∞·ªùi d√πng
                </a>
                <a href="./documents.html" class="nav-link active">
                    <span class="nav-icon">üìÑ</span>
                    T√†i li·ªáu
                </a>
                <a href="./categories.html" class="nav-link">
                    <span class="nav-icon">üìÅ</span>
                    Danh m·ª•c
                </a>
                <div class="nav-buttons">
                    <div class="user-dropdown">
                        <button class="user-dropdown-btn" onclick="toggleUserDropdown()">
                            <span class="user-icon">üë§</span>
                            <span id="userNameHeader">Admin</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <span class="user-icon">üë§</span>
                                <span id="dropdownUserEmail" style="margin-left: 8px;">admin@example.com</span>
                            </div>
                            <div class="dropdown-content-grid">
                                <a href="./dashboard.html" class="dropdown-item">
                                    <span class="dropdown-icon">üéõÔ∏è</span>
                                    <span>Dashboard</span>
                                </a>
                                <a href="./users.html" class="dropdown-item">
                                    <span class="dropdown-icon">üë•</span>
                                    <span>Ng∆∞·ªùi d√πng</span>
                                </a>
                                <a href="./documents.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìÑ</span>
                                    <span>T√†i li·ªáu</span>
                                </a>
                                <a href="./categories.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìÅ</span>
                                    <span>Danh m·ª•c</span>
                                </a>
                            </div>
                            <div class="dropdown-divider"></div>
                            <button onclick="logout()" class="dropdown-item dropdown-logout">
                                <span class="dropdown-icon">üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Documents Management -->
    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h2>üìÑ Qu·∫£n l√Ω t√†i li·ªáu</h2>
                <p>Qu·∫£n l√Ω t·∫•t c·∫£ t√†i li·ªáu trong h·ªá th·ªëng</p>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-number" id="totalDocs">0</div>
                    <div class="stat-label">T·ªïng t√†i li·ªáu</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üëÅÔ∏è</div>
                    <div class="stat-number" id="totalViews">0</div>
                    <div class="stat-label">T·ªïng l∆∞·ª£t xem</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚¨áÔ∏è</div>
                    <div class="stat-number" id="totalDownloads">0</div>
                    <div class="stat-label">T·ªïng l∆∞·ª£t t·∫£i</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ú®</div>
                    <div class="stat-number" id="newDocsToday">0</div>
                    <div class="stat-label">M·ªõi h√¥m nay</div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="table-container" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px;">
                    <input type="text" 
                           id="searchDoc" 
                           placeholder="T√¨m ki·∫øm t√†i li·ªáu..." 
                           style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;"
                           aria-label="T√¨m ki·∫øm t√†i li·ªáu">
                    <select id="filterCategory" 
                            style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px;"
                            aria-label="L·ªçc theo danh m·ª•c">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                    <button class="btn" id="searchBtn">
                        üîç T√¨m ki·∫øm
                    </button>
                </div>
            </div>

            <!-- Documents Table -->
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Danh s√°ch t√†i li·ªáu</h3>
                    <span id="docCount" style="color: #444; font-size: 0.95rem;"></span>
                </div>
                <div id="documentsList"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 DocShare - Chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" onclick="scrollToTop()">
        ‚Üë
    </button>

    <script src="../main.js"></script>
    <script src="../header-auth.js"></script>
    <script>
        // ===================================
        // USER DROPDOWN TOGGLE
        // ===================================
        function toggleUserDropdown() {
            const menu = document.getElementById('userDropdownMenu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.user-dropdown');
            const menu = document.getElementById('userDropdownMenu');
            if (dropdown && menu && !dropdown.contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        // ===================================
        // STATE MANAGEMENT
        // ===================================
        let allDocuments = [];
        let categories = [];

        // ===================================
        // AUTHENTICATION CHECK
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAdminAuth()) {
                return;
            }
            
            initializePage();
        });

        function checkAdminAuth() {
            const user = getUser();
            const token = getToken();
            
            if (!user || !token) {
                showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c', 'error');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1500);
                return false;
            }
            
            if (user.chuc_vu !== 'admin') {
                showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!', 'error');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1500);
                return false;
            }
            
            return true;
        }

        // ===================================
        // PAGE INITIALIZATION
        // ===================================
        async function initializePage() {
            setupEventListeners();
            await loadCategories();
            await loadDocuments();
        }

        function setupEventListeners() {
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }

            // Search input
            const searchInput = document.getElementById('searchDoc');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterAndDisplayDocuments, 300));
            }

            // Filter select
            const filterCategory = document.getElementById('filterCategory');
            if (filterCategory) {
                filterCategory.addEventListener('change', filterAndDisplayDocuments);
            }

            // Search button
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                searchBtn.addEventListener('click', filterAndDisplayDocuments);
            }
        }

        // ===================================
        // LOAD CATEGORIES
        // ===================================
        async function loadCategories() {
            try {
                const response = await apiGet('/categories/danhmuc');
                
                if (response && response.ok) {
                    categories = await response.json();
                    populateCategoryFilter();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function populateCategoryFilter() {
            const select = document.getElementById('filterCategory');
            if (!select) return;

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.ma_danh_muc;
                option.textContent = cat.ten_danh_muc;
                select.appendChild(option);
            });
        }

        // ===================================
        // LOAD DOCUMENTS
        // ===================================
        async function loadDocuments() {
            showLoading();
            
            try {
                const response = await apiGet('/admin/documents?limit=1000');

                if (response && response.ok) {
                    const data = await response.json();
                    allDocuments = Array.isArray(data) ? data : (data.documents || []);
                    filterAndDisplayDocuments();
                    updateStats();
                } else {
                    throw new Error('Failed to load documents');
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i li·ªáu', 'error');
                displayEmptyState('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // FILTER AND DISPLAY
        // ===================================
        function filterAndDisplayDocuments() {
            const searchInput = document.getElementById('searchDoc');
            const filterCategory = document.getElementById('filterCategory');
            
            if (!searchInput || !filterCategory) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const categoryFilter = filterCategory.value;

            let filtered = allDocuments.filter(doc => {
                const matchSearch = !searchTerm || 
                    doc.tieu_de.toLowerCase().includes(searchTerm) ||
                    (doc.mo_ta && doc.mo_ta.toLowerCase().includes(searchTerm)) ||
                    (doc.ten_tap && doc.ten_tap.toLowerCase().includes(searchTerm));
                
                const matchCategory = !categoryFilter || doc.ma_danh_muc == categoryFilter;
                
                return matchSearch && matchCategory;
            });

            displayDocuments(filtered);
            updateDocCount(filtered.length, allDocuments.length);
        }

        function displayDocuments(docs) {
            const container = document.getElementById('documentsList');
            
            if (!container) return;

            if (docs.length === 0) {
                displayEmptyState('Kh√¥ng t√¨m th·∫•y t√†i li·ªáu n√†o');
                return;
            }

            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ti√™u ƒë·ªÅ</th>
                                <th>Ng∆∞·ªùi t·∫£i</th>
                                <th>Danh m·ª•c</th>
                                <th>Ng√†y t·∫£i</th>
                                <th>L∆∞·ª£t xem</th>
                                <th>L∆∞·ª£t t·∫£i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            docs.forEach(doc => {
                const date = formatDate(new Date(doc.ngay_tai));

                html += `
                    <tr>
                        <td>${doc.ma_tai_lieu}</td>
                        <td>
                            <strong>${escapeHtml(doc.tieu_de)}</strong><br>
                            <small style="color: #444;">${escapeHtml(doc.ten_tap || 'N/A')}</small>
                        </td>
                        <td>${escapeHtml(doc.email || 'N/A')}</td>
                        <td>
                            <span style="background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">
                                ${escapeHtml(doc.ten_danh_muc || 'N/A')}
                            </span>
                        </td>
                        <td>${date}</td>
                        <td>
                            <span style="display: flex; align-items: center; gap: 5px;">
                                üëÅÔ∏è <strong>${formatNumber(doc.so_luot_xem || 0)}</strong>
                            </span>
                        </td>
                        <td>
                            <span style="display: flex; align-items: center; gap: 5px;">
                                ‚¨áÔ∏è <strong>${formatNumber(doc.so_luot_tai || 0)}</strong>
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm" 
                                    onclick="viewDoc(${doc.ma_tai_lieu})" 
                                    style="background: #3498db;"
                                    title="Xem chi ti·∫øt">
                                üëÅÔ∏è Xem
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    onclick="deleteDoc(${doc.ma_tai_lieu}, '${escapeHtml(doc.tieu_de)}')"
                                    title="X√≥a t√†i li·ªáu">
                                üóëÔ∏è X√≥a
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ===================================
        // UPDATE STATS
        // ===================================
        function updateStats() {
            const totalDocs = allDocuments.length;
            const totalViews = allDocuments.reduce((sum, doc) => sum + (doc.so_luot_xem || 0), 0);
            const totalDownloads = allDocuments.reduce((sum, doc) => sum + (doc.so_luot_tai || 0), 0);
            
            const today = new Date().toDateString();
            const newDocsToday = allDocuments.filter(doc => 
                new Date(doc.ngay_tai).toDateString() === today
            ).length;

            animateNumber(document.getElementById('totalDocs'), totalDocs);
            animateNumber(document.getElementById('totalViews'), totalViews);
            animateNumber(document.getElementById('totalDownloads'), totalDownloads);
            animateNumber(document.getElementById('newDocsToday'), newDocsToday);
        }

        function updateDocCount(filtered, total) {
            const countElem = document.getElementById('docCount');
            if (countElem) {
                if (filtered === total) {
                    countElem.textContent = `Hi·ªÉn th·ªã ${total} t√†i li·ªáu`;
                } else {
                    countElem.textContent = `Hi·ªÉn th·ªã ${filtered} / ${total} t√†i li·ªáu`;
                }
            }
        }

        // ===================================
        // VIEW DOCUMENT
        // ===================================
        function viewDoc(id) {
            window.location.href = `../documents/detail.html?id=${id}`;
        }

        // ===================================
        // DELETE DOCUMENT
        // ===================================
        async function deleteDoc(id, title) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i li·ªáu "${title}"?\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                return;
            }

            showLoading();

            try {
                const response = await apiDelete(`/documents/${id}`);

                if (response && response.ok) {
                    showToast('X√≥a t√†i li·ªáu th√†nh c√¥ng!', 'success');
                    await loadDocuments();
                } else {
                    const data = await response.json();
                    showToast(data.message || 'X√≥a th·∫•t b·∫°i!', 'error');
                }
            } catch (error) {
                console.error('Error deleting document:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a!', 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        function displayEmptyState(message) {
            const container = document.getElementById('documentsList');
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>${message}</h3>
                        <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·ª´ kh√≥a t√¨m ki·∫øm</p>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function animateNumber(element, target) {
            if (!element) return;
            
            const duration = 1000;
            const frameDuration = 1000 / 60;
            const totalFrames = Math.round(duration / frameDuration);
            const increment = target / totalFrames;
            
            let current = 0;
            let frame = 0;
            
            const counter = setInterval(() => {
                frame++;
                current += increment;
                
                if (frame === totalFrames) {
                    clearInterval(counter);
                    current = target;
                }
                
                element.textContent = formatNumber(Math.floor(current));
            }, frameDuration);
        }
    </script>

    <!-- Chatbot Widget -->
    <script src="../chatbot-widget.js"></script>
</body>
</html>