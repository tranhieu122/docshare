<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ƒêƒÉng k√Ω t√†i kho·∫£n DocShare - N·ªÅn t·∫£ng chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p">
    <title>ƒêƒÉng k√Ω - DocShare</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>ƒêang x·ª≠ l√Ω...</p>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <span id="toastMessage"></span>
        <button onclick="closeToast()" class="toast-close">&times;</button>
    </div>

    <!-- Auth Container -->
    <div class="auth-container">
        <div class="auth-box">
            <!-- Logo -->
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 5px;">üìö DocShare</h1>
                <p style="color: #666; font-size: 0.95rem;">Chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p</p>
            </div>

            <h2>üìù ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
            
            <!-- Alert Message -->
            <div id="alertMessage"></div>
            
            <!-- Register Form -->
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="fullName">
                        <span style="color: #667eea;">üë§</span> H·ªç v√† t√™n
                    </label>
                    <input 
                        type="text" 
                        id="fullName" 
                        name="fullName" 
                        required 
                        placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß"
                        autocomplete="name"
                        minlength="3"
                    >
                    <small style="color: #666;">T·ªëi thi·ªÉu 3 k√Ω t·ª±</small>
                </div>

                <div class="form-group">
                    <label for="email">
                        <span style="color: #667eea;">üìß</span> Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required 
                        placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email"
                        autocomplete="email"
                    >
                    <small style="color: #666;">S·ª≠ d·ª•ng email th·∫≠t ƒë·ªÉ x√°c th·ª±c t√†i kho·∫£n</small>
                </div>
                
                <div class="form-group">
                    <label for="password">
                        <span style="color: #667eea;">üîí</span> M·∫≠t kh·∫©u
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                        autocomplete="new-password"
                        minlength="6"
                    >
                    <small style="color: #666;">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">
                        <span style="color: #667eea;">üîí</span> X√°c nh·∫≠n m·∫≠t kh·∫©u
                    </label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        required 
                        placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                        autocomplete="new-password"
                        minlength="6"
                    >
                    <small style="color: #666;">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n</small>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: start; gap: 10px; margin: 0; cursor: pointer;">
                        <input type="checkbox" id="agreeTerms" required style="width: auto; margin-top: 4px; cursor: pointer;">
                        <span style="font-size: 0.9rem; color: #555; line-height: 1.5;">
                            T√¥i ƒë·ªìng √Ω v·ªõi 
                            <a href="./terms.html" style="color: #667eea; text-decoration: underline;" target="_blank">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> 
                            v√† 
                            <a href="./privacy.html" style="color: #667eea; text-decoration: underline;" target="_blank">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
                        </span>
                    </label>
                </div>
                
                <button type="submit" class="btn" id="registerBtn">
                    <span>üöÄ</span> ƒêƒÉng k√Ω
                </button>
            </form>
            
            <!-- Divider -->
            <div style="position: relative; text-align: center; margin: 30px 0;">
                <div style="border-top: 2px solid #e9ecef;"></div>
                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0 15px; color: #666; font-size: 0.9rem;">
                    ho·∫∑c
                </span>
            </div>
            
            <!-- Quick Register Options -->
            <div style="display: grid; gap: 12px; margin-bottom: 25px;">
                <button type="button" class="btn" style="background: white; color: #333; border: 2px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.08);" onclick="showToast('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn', 'info')">
                    <span style="font-size: 1.2rem;">üîµ</span> ƒêƒÉng k√Ω v·ªõi Google
                </button>
                <button type="button" class="btn" style="background: white; color: #333; border: 2px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.08);" onclick="showToast('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn', 'info')">
                    <span style="font-size: 1.2rem;">üìò</span> ƒêƒÉng k√Ω v·ªõi Facebook
                </button>
            </div>
            
            <!-- Auth Footer -->
            <div class="auth-footer">
                <p style="margin-bottom: 15px;">
                    ƒê√£ c√≥ t√†i kho·∫£n? 
                    <a href="./login.html">ƒêƒÉng nh·∫≠p ngay</a>
                </p>
                <p style="margin: 0;">
                    <a href="./index.html" style="display: inline-flex; align-items: center; gap: 5px;">
                        <span>‚Üê</span> Quay v·ªÅ trang ch·ªß
                    </a>
                </p>
            </div>

            <!-- Benefits Section -->
            <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px;">
                <h4 style="text-align: center; margin-bottom: 20px; color: #2c3e50; font-size: 1.1rem;">
                    ‚ú® L·ª£i √≠ch khi ƒëƒÉng k√Ω
                </h4>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">üìö</span>
                        <span style="color: #555; font-size: 0.9rem;">Truy c·∫≠p h√†ng ng√†n t√†i li·ªáu mi·ªÖn ph√≠</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">‚¨ÜÔ∏è</span>
                        <span style="color: #555; font-size: 0.9rem;">Chia s·∫ª t√†i li·ªáu c·ªßa b·∫°n</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">üí¨</span>
                        <span style="color: #555; font-size: 0.9rem;">Tham gia c·ªông ƒë·ªìng sinh vi√™n</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">‚≠ê</span>
                        <span style="color: #555; font-size: 0.9rem;">ƒê√°nh gi√° v√† b√¨nh lu·∫≠n t√†i li·ªáu</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">üîî</span>
                        <span style="color: #555; font-size: 0.9rem;">Nh·∫≠n th√¥ng b√°o t√†i li·ªáu m·ªõi</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // API Configuration
        const API_URL = 'http://localhost:3000/api';
        
        // Helper functions
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function getUser() {
            const userStr = localStorage.getItem('user');
            return userStr ? JSON.parse(userStr) : null;
        }
        
        function getToken() {
            return localStorage.getItem('token');
        }
        
        function showToast(message, type) {
            console.log(`Toast [${type}]: ${message}`);
        }
        
        // Handle Register
        async function handleRegister(event) {
            event.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            const alertDiv = document.getElementById('alertMessage');
            const registerBtn = document.getElementById('registerBtn');
            
            // Clear previous alerts
            alertDiv.innerHTML = '';
            
            // Validate full name
            if (fullName.length < 3) {
                alertDiv.innerHTML = '<div class="alert alert-error">H·ªç t√™n ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!</div>';
                return;
            }
            
            // Validate email
            if (!validateEmail(email)) {
                alertDiv.innerHTML = '<div class="alert alert-error">Email kh√¥ng h·ª£p l·ªá!</div>';
                return;
            }
            
            // Validate password
            if (password.length < 6) {
                alertDiv.innerHTML = '<div class="alert alert-error">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!</div>';
                return;
            }
            
            // Validate password match
            if (password !== confirmPassword) {
                alertDiv.innerHTML = '<div class="alert alert-error">M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!</div>';
                return;
            }
            
            // Check terms agreement
            if (!agreeTerms) {
                alertDiv.innerHTML = '<div class="alert alert-error">Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng!</div>';
                return;
            }
            
            // Show loading
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<span>‚åõ</span> ƒêang ƒëƒÉng k√Ω...';
            alertDiv.innerHTML = '<div class="alert alert-info">ƒêang x·ª≠ l√Ω...</div>';
            
            try {
                console.log('=== B·∫ÆT ƒê·∫¶U ƒêƒÇNG K√ù ===');
                console.log('API URL:', `${API_URL}/auth/register`);
                console.log('Email:', email);
                
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        mat_khau: password,
                        ho_ten: fullName
                    })
                });
                
                const data = await response.json();
                console.log('Response status:', response.status);
                console.log('Response data:', data);
                
                if (response.ok) {
                    // Registration successful
                    console.log('‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng!');
                    alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...</div>';
                    
                    // Option 1: Auto login after registration
                    if (data.token) {
                        console.log('C√≥ token - t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p');
                        // Save user data and token
                        localStorage.setItem('user', JSON.stringify(data.user));
                        localStorage.setItem('token', data.token);
                        
                        // Redirect to student home
                        setTimeout(() => {
                            console.log('Chuy·ªÉn ƒë·∫øn student home');
                            window.location.href = './sinhvien/home.html';
                        }, 1000);
                    } else {
                        // Option 2: Redirect to login page
                        console.log('Kh√¥ng c√≥ token - chuy·ªÉn ƒë·∫øn login');
                        setTimeout(() => {
                            window.location.href = './login.html?registered=true';
                        }, 1000);
                    }
                    
                } else {
                    // Registration failed
                    console.log('‚ùå ƒêƒÉng k√Ω th·∫•t b·∫°i:', data);
                    registerBtn.disabled = false;
                    registerBtn.innerHTML = '<span>üöÄ</span> ƒêƒÉng k√Ω';
                    
                    const errorMessage = data.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i!';
                    alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${errorMessage}</div>`;
                }
                
            } catch (error) {
                console.error('‚ùå L·ªñI K·∫æT N·ªêI:', error);
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<span>üöÄ</span> ƒêƒÉng k√Ω';
                
                const errorMessage = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i!';
                alertDiv.innerHTML = `<div class="alert alert-error">‚ùå ${errorMessage}</div>`;
                showToast(errorMessage, 'error');
            }
        }

        // Check if already logged in
        window.addEventListener('DOMContentLoaded', function() {
            const user = getUser();
            const token = getToken();
            
            if (user && token) {
                showToast('B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p', 'info');
                
                // Redirect based on role
                setTimeout(() => {
                    if (user.chuc_vu === 'admin' || user.email === 'admin@test.com') {
                        window.location.href = './admin/dashboard.html';
                    } else {
                        window.location.href = './sinhvien/home.html';
                    }
                }, 1000);
            }
            
            // Check if coming from login page with success message
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from') === 'login') {
                showToast('Vui l√≤ng ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi', 'info');
            }
        });

        // Real-time password match validation
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            
            if (confirmPassword && password !== confirmPassword) {
                this.style.borderColor = '#e74c3c';
            } else {
                this.style.borderColor = '#667eea';
            }
        });

        // Password strength indicator
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            // Check password strength
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;
            
            // Show strength indicator
            const strengthText = ['Y·∫øu', 'Trung b√¨nh', 'M·∫°nh', 'R·∫•t m·∫°nh'];
            const strengthColor = ['#e74c3c', '#f39c12', '#27ae60', '#27ae60'];
            
            const small = this.nextElementSibling;
            if (password.length > 0) {
                const level = Math.min(strength - 1, 3);
                if (level >= 0) {
                    small.textContent = `ƒê·ªô m·∫°nh m·∫≠t kh·∫©u: ${strengthText[level]}`;
                    small.style.color = strengthColor[level];
                    small.style.fontWeight = '600';
                }
            } else {
                small.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
                small.style.color = '#666';
                small.style.fontWeight = 'normal';
            }
        });

        // Handle Enter key on confirm password field
        document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleRegister(e);
            }
        });

        // Email validation on blur
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !validateEmail(email)) {
                this.style.borderColor = '#e74c3c';
                this.nextElementSibling.textContent = 'Email kh√¥ng h·ª£p l·ªá';
                this.nextElementSibling.style.color = '#e74c3c';
            } else if (email) {
                this.style.borderColor = '#667eea';
                this.nextElementSibling.textContent = 'S·ª≠ d·ª•ng email th·∫≠t ƒë·ªÉ x√°c th·ª±c t√†i kho·∫£n';
                this.nextElementSibling.style.color = '#666';
            }
        });

        // Full name validation on blur
        document.getElementById('fullName').addEventListener('blur', function() {
            const fullName = this.value.trim();
            if (fullName && fullName.length < 3) {
                this.style.borderColor = '#e74c3c';
                this.nextElementSibling.textContent = 'H·ªç t√™n qu√° ng·∫Øn';
                this.nextElementSibling.style.color = '#e74c3c';
            } else if (fullName) {
                this.style.borderColor = '#667eea';
                this.nextElementSibling.textContent = 'T·ªëi thi·ªÉu 3 k√Ω t·ª±';
                this.nextElementSibling.style.color = '#666';
            }
        });

        // Auto-focus first input
        document.getElementById('fullName').focus();
    </script>
</body>
</html>