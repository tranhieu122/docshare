<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="T·∫£i l√™n t√†i li·ªáu - DocShare">
    <title>T·∫£i l√™n t√†i li·ªáu - DocShare</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <style>
        /* Additional Upload Page Styles */
        .upload-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .upload-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .upload-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e9ecef;
            z-index: 0;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: #999;
            transition: all 0.3s ease;
        }

        .step-item.active .step-circle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .step-item.completed .step-circle {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        .step-label {
            font-weight: 600;
            color: #999;
            font-size: 0.9rem;
            text-align: center;
        }

        .step-item.active .step-label {
            color: #667eea;
        }

        .step-item.completed .step-label {
            color: #27ae60;
        }

        .upload-section {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #e9ecef;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-style: solid;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .upload-browse-btn {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-browse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .file-input-hidden {
            display: none;
        }

        .file-requirements {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .requirements-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .requirements-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
            font-size: 0.9rem;
        }

        .requirement-icon {
            color: #27ae60;
            font-size: 1.1rem;
        }

        .files-preview {
            margin-top: 30px;
        }

        .file-preview-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .file-preview-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .file-icon-preview {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            flex-shrink: 0;
        }

        .file-info-preview {
            flex: 1;
            min-width: 0;
        }

        .file-name-preview {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size-preview {
            color: #666;
            font-size: 0.9rem;
        }

        .file-progress {
            margin-top: 10px;
        }

        .progress-bar-container {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .file-remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .file-remove-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .file-preview-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin-right: 8px;
        }

        .file-preview-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-field-full {
            grid-column: 1 / -1;
        }

        .char-counter {
            text-align: right;
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .char-counter.warning {
            color: #f39c12;
        }

        .char-counter.danger {
            color: #e74c3c;
        }

        .upload-tips {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px 25px;
            border-radius: 12px;
            border-left: 4px solid #2196F3;
        }

        .tips-title {
            font-weight: 700;
            color: #1976D2;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-list {
            list-style: none;
            padding: 0;
        }

        .tips-list li {
            padding: 8px 0;
            color: #0d47a1;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .tips-list li::before {
            content: 'üí°';
            flex-shrink: 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-primary {
            flex: 1;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            flex: 1;
            padding: 15px 30px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-3px);
        }

        .success-animation {
            text-align: center;
            padding: 60px 20px;
        }

        .success-icon {
            font-size: 6rem;
            margin-bottom: 20px;
            animation: bounceIn 0.6s ease;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        .success-title {
            font-size: 2rem;
            color: #27ae60;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .success-message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
        }

        .uploaded-files-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: left;
        }

        .uploaded-file-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Draft Indicator */
        .draft-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .draft-indicator.show {
            opacity: 1;
        }

        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            overflow: auto;
        }

        .preview-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }

        .preview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 2rem;
            cursor: pointer;
            color: #e74c3c;
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .preview-close:hover {
            background: #e74c3c;
            color: white;
        }

        /* Upload Queue Status */
        .upload-queue-status {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
        }

        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-status {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
        }

        .queue-status.uploading {
            background: #2196F3;
            color: white;
        }

        .queue-status.completed {
            background: #4caf50;
            color: white;
        }

        .queue-status.failed {
            background: #f44336;
            color: white;
        }

        @media (max-width: 768px) {
            .upload-steps {
                flex-direction: column;
                gap: 20px;
            }

            .upload-steps::before {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .file-preview-item {
                flex-direction: column;
                text-align: center;
            }

            .upload-section {
                padding: 25px 20px;
            }

            .draft-indicator {
                top: 70px;
                right: 10px;
                font-size: 0.8rem;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loadingText">ƒêang t·∫£i l√™n...</p>
        <button class="btn-danger" onclick="cancelUpload()" style="margin-top: 20px;">
            H·ªßy t·∫£i l√™n
        </button>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <span id="toastMessage"></span>
        <button onclick="closeToast()" class="toast-close">&times;</button>
    </div>

    <!-- Draft Indicator -->
    <div id="draftIndicator" class="draft-indicator">
        üíæ ƒê√£ l∆∞u b·∫£n nh√°p
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <button class="preview-close" onclick="closePreviewModal()">&times;</button>
            <div id="previewContainer"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="../index.html" style="text-decoration: none; color: inherit;">
                    <h1>üìö DocShare</h1>
                </a>
                <span class="logo-subtitle">H·ªçc t·∫≠p & Chia s·∫ª</span>
            </div>
            <nav class="nav">
                <a href="../index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    Trang ch·ªß
                </a>
                <a href="../documents/list.html" class="nav-link">
                    <span class="nav-icon">üîç</span>
                    Kh√°m ph√°
                </a>
                <a href="../features.html" class="nav-link">
                    <span class="nav-icon">‚ú®</span>
                    T√≠nh nƒÉng
                </a>
                <a href="../about.html" class="nav-link">
                    <span class="nav-icon">‚ÑπÔ∏è</span>
                    V·ªÅ ch√∫ng t√¥i
                </a>
                <div class="nav-buttons" id="authButtons" style="display: none;">
                    <a href="../login.html" class="btn-login">
                        <span>üîë</span> ƒêƒÉng nh·∫≠p
                    </a>
                    <a href="../register.html" class="btn-register">
                        <span>üìù</span> ƒêƒÉng k√Ω
                    </a>
                </div>
                <!-- User Dropdown (ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p) -->
                <div class="nav-buttons" id="userSection">
                    <a href="../admin/dashboard.html" id="adminLink" class="btn-danger" style="display: none;">
                        <span>üîë</span> Qu·∫£n tr·ªã
                    </a>
                    <div class="user-dropdown">
                        <button class="user-dropdown-btn" onclick="toggleUserDropdown()">
                            <span class="user-icon">üë§</span>
                            <span id="userNameHeader">Ng∆∞·ªùi d√πng</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <span class="user-icon">üë§</span>
                                <span id="dropdownUserEmail" style="margin-left: 8px;">email@example.com</span>
                            </div>
                            <div class="dropdown-content-grid">
                                <a href="./home.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìä</span>
                                    <span>Dashboard</span>
                                </a>
                                <a href="./my-documents.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìÑ</span>
                                    <span>T√†i li·ªáu c·ªßa t√¥i</span>
                                </a>
                                <a href="./upload.html" class="dropdown-item">
                                    <span class="dropdown-icon">‚¨ÜÔ∏è</span>
                                    <span>T·∫£i l√™n</span>
                                </a>
                                <a href="./profile.html" class="dropdown-item">
                                    <span class="dropdown-icon">‚öôÔ∏è</span>
                                    <span>C√†i ƒë·∫∑t</span>
                                </a>
                            </div>
                            <div class="dropdown-divider"></div>
                            <button onclick="logout()" class="dropdown-item dropdown-logout">
                                <span class="dropdown-icon">üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <section class="dashboard">
        <div class="container upload-container">
            <!-- Page Header -->
            <div class="dashboard-header">
                <div>
                    <h2>‚¨ÜÔ∏è T·∫£i l√™n t√†i li·ªáu</h2>
                    <p style="opacity: 0.9; margin-top: 8px; font-size: 1.05rem;">Chia s·∫ª ki·∫øn th·ª©c c·ªßa b·∫°n v·ªõi c·ªông ƒë·ªìng</p>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="loadDraft()" class="btn-cta-secondary" style="padding: 12px 25px; font-size: 1rem; background: rgba(255,255,255,0.2); border: 2px solid white;">
                        <span>üíæ</span> T·∫£i b·∫£n nh√°p
                    </button>
                    <a href="./my-documents.html" class="btn-cta-secondary" style="padding: 12px 25px; font-size: 1rem; background: rgba(255,255,255,0.2); border: 2px solid white;">
                        <span>üìÑ</span> T√†i li·ªáu c·ªßa t√¥i
                    </a>
                </div>
            </div>

            <!-- Upload Steps -->
            <div class="upload-steps">
                <div class="step-item active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Ch·ªçn file</div>
                </div>
                <div class="step-item" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Th√¥ng tin</div>
                </div>
                <div class="step-item" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">X√°c nh·∫≠n</div>
                </div>
                <div class="step-item" id="step4">
                    <div class="step-circle">‚úì</div>
                    <div class="step-label">Ho√†n th√†nh</div>
                </div>
            </div>

            <!-- Step 1: Upload File -->
            <div class="upload-section" id="uploadStep1">
                <h3 class="section-title">
                    <span>üìÅ</span>
                    B∆∞·ªõc 1: Ch·ªçn t√†i li·ªáu
                </h3>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">K√©o th·∫£ file v√†o ƒë√¢y</div>
                    <div class="upload-subtext">ho·∫∑c</div>
                    <label class="upload-browse-btn">
                        Ch·ªçn file t·ª´ m√°y t√≠nh
                        <input type="file" class="file-input-hidden" id="fileInput" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt" multiple>
                    </label>
                </div>

                <div class="file-requirements">
                    <div class="requirements-title">
                        <span>‚ÑπÔ∏è</span>
                        Y√™u c·∫ßu file
                    </div>
                    <div class="requirements-list">
                        <div class="requirement-item">
                            <span class="requirement-icon">‚úì</span>
                            <span>ƒê·ªãnh d·∫°ng: PDF, DOC, DOCX, PPT, PPTX</span>
                        </div>
                        <div class="requirement-item">
                            <span class="requirement-icon">‚úì</span>
                            <span>K√≠ch th∆∞·ªõc t·ªëi ƒëa: 50MB</span>
                        </div>
                        <div class="requirement-item">
                            <span class="requirement-icon">‚úì</span>
                            <span>C√≥ th·ªÉ t·∫£i nhi·ªÅu file c√πng l√∫c</span>
                        </div>
                        <div class="requirement-item">
                            <span class="requirement-icon">‚úì</span>
                            <span>File ph·∫£i r√µ r√†ng, d·ªÖ ƒë·ªçc</span>
                        </div>
                    </div>
                </div>

                <!-- Files Preview -->
                <div class="files-preview" id="filesPreview" style="display: none;">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; font-weight: 700;">
                        üìã Danh s√°ch file ƒë√£ ch·ªçn (<span id="fileCount">0</span>)
                    </h4>
                    <div id="filesList"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary" onclick="clearFiles()">
                        <span>üóëÔ∏è</span> X√≥a t·∫•t c·∫£
                    </button>
                    <button class="btn-primary" onclick="goToStep(2)" id="btnNextStep1" disabled>
                        <span>‚Üí</span> Ti·∫øp theo
                    </button>
                </div>
            </div>

            <!-- Step 2: Document Information -->
            <div class="upload-section" id="uploadStep2" style="display: none;">
                <h3 class="section-title">
                    <span>üìù</span>
                    B∆∞·ªõc 2: Th√¥ng tin t√†i li·ªáu
                </h3>

                <form id="documentForm">
                    <div class="form-grid">
                        <div class="form-group form-field-full">
                            <label for="docTitle">
                                <span style="color: #667eea;">üìå</span> Ti√™u ƒë·ªÅ t√†i li·ªáu *
                            </label>
                            <input 
                                type="text" 
                                id="docTitle" 
                                required 
                                placeholder="Nh·∫≠p ti√™u ƒë·ªÅ r√µ r√†ng, d·ªÖ hi·ªÉu"
                                maxlength="200"
                                oninput="updateCharCount('docTitle', 'titleCount', 200); saveDraftAuto()"
                            >
                            <div class="char-counter" id="titleCount">0/200 k√Ω t·ª±</div>
                        </div>

                        <div class="form-group form-field-full">
                            <label for="docDescription">
                                <span style="color: #667eea;">üìÑ</span> M√¥ t·∫£ t√†i li·ªáu *
                            </label>
                            <textarea 
                                id="docDescription" 
                                required 
                                rows="5"
                                placeholder="M√¥ t·∫£ n·ªôi dung t√†i li·ªáu, c√°c ch·ªß ƒë·ªÅ ch√≠nh..."
                                maxlength="1000"
                                oninput="updateCharCount('docDescription', 'descCount', 1000); saveDraftAuto()"
                            ></textarea>
                            <div class="char-counter" id="descCount">0/1000 k√Ω t·ª±</div>
                        </div>

                        <div class="form-group">
                            <label for="docCategory">
                                <span style="color: #667eea;">üìö</span> Danh m·ª•c *
                            </label>
                            <select id="docCategory" required onchange="saveDraftAuto()">
                                <option value="">Ch·ªçn danh m·ª•c</option>
                                <option value="tech">üñ•Ô∏è C√¥ng ngh·ªá th√¥ng tin</option>
                                <option value="science">üî¨ Khoa h·ªçc t·ª± nhi√™n</option>
                                <option value="business">üíº Kinh t·∫ø & Kinh doanh</option>
                                <option value="language">üåê Ng√¥n ng·ªØ</option>
                                <option value="social">üìñ Khoa h·ªçc x√£ h·ªôi</option>
                                <option value="engineering">‚öôÔ∏è K·ªπ thu·∫≠t</option>
                                <option value="medicine">‚öïÔ∏è Y d∆∞·ª£c</option>
                                <option value="art">üé® Ngh·ªá thu·∫≠t</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="docSubject">
                                <span style="color: #667eea;">üìñ</span> M√¥n h·ªçc *
                            </label>
                            <select 
                                id="docSubject" 
                                required
                                onchange="saveDraftAuto()"
                            >
                                <option value="">Ch·ªçn m√¥n h·ªçc</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="docLevel">
                                <span style="color: #667eea;">üéì</span> Tr√¨nh ƒë·ªô
                            </label>
                            <select id="docLevel" onchange="saveDraftAuto()">
                                <option value="">Ch·ªçn tr√¨nh ƒë·ªô</option>
                                <option value="beginner">C∆° b·∫£n</option>
                                <option value="intermediate">Trung c·∫•p</option>
                                <option value="advanced">N√¢ng cao</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="docLanguage">
                                <span style="color: #667eea;">üó£Ô∏è</span> Ng√¥n ng·ªØ
                            </label>
                            <select id="docLanguage" onchange="saveDraftAuto()">
                                <option value="vi">Ti·∫øng Vi·ªát</option>
                                <option value="en">English</option>
                                <option value="both">Song ng·ªØ</option>
                            </select>
                        </div>

                        <div class="form-group form-field-full">
                            <label for="docTags">
                                <span style="color: #667eea;">üè∑Ô∏è</span> T·ª´ kh√≥a (Tags)
                            </label>
                            <input 
                                type="text" 
                                id="docTags" 
                                placeholder="Nh·∫≠p t·ª´ kh√≥a, c√°ch nhau b·∫±ng d·∫•u ph·∫©y (VD: to√°n, gi·∫£i t√≠ch, ƒë·∫°i s·ªë)"
                                oninput="saveDraftAuto()"
                            >
                            <small style="color: #666;">Gi√∫p ng∆∞·ªùi kh√°c d·ªÖ d√†ng t√¨m th·∫•y t√†i li·ªáu c·ªßa b·∫°n</small>
                        </div>

                        <div class="form-group form-field-full">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="docAgree" required style="width: auto; cursor: pointer;">
                                <span style="color: #555;">
                                    T√¥i x√°c nh·∫≠n r·∫±ng t√†i li·ªáu n√†y kh√¥ng vi ph·∫°m b·∫£n quy·ªÅn v√† tu√¢n th·ªß 
                                    <a href="../terms.html" target="_blank" style="color: #667eea; text-decoration: underline;">ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                                </span>
                            </label>
                        </div>
                    </div>
                </form>

                <div class="upload-tips" style="margin-top: 30px;">
                    <div class="tips-title">
                        üí° M·∫πo t·∫£i l√™n hi·ªáu qu·∫£
                    </div>
                    <ul class="tips-list">
                        <li>ƒê·∫∑t ti√™u ƒë·ªÅ r√µ r√†ng, c√≥ t·ª´ kh√≥a quan tr·ªçng</li>
                        <li>M√¥ t·∫£ chi ti·∫øt n·ªôi dung ƒë·ªÉ ng∆∞·ªùi ƒë·ªçc hi·ªÉu r√µ</li>
                        <li>Ch·ªçn ƒë√∫ng danh m·ª•c v√† m√¥n h·ªçc</li>
                        <li>Th√™m nhi·ªÅu t·ª´ kh√≥a ƒë·ªÉ tƒÉng kh·∫£ nƒÉng t√¨m ki·∫øm</li>
                        <li>ƒê·∫£m b·∫£o file r√µ r√†ng, kh√¥ng l·ªói</li>
                    </ul>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary" onclick="goToStep(1)">
                        <span>‚Üê</span> Quay l·∫°i
                    </button>
                    <button class="btn-primary" onclick="goToStep(3)">
                        <span>‚Üí</span> Xem tr∆∞·ªõc
                    </button>
                </div>
            </div>

            <!-- Step 3: Preview & Confirm -->
            <div class="upload-section" id="uploadStep3" style="display: none;">
                <h3 class="section-title">
                    <span>üëÅÔ∏è</span>
                    B∆∞·ªõc 3: X√°c nh·∫≠n th√¥ng tin
                </h3>

                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 30px; border-radius: 12px; margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; font-weight: 700;">üìã Th√¥ng tin t√†i li·ªáu</h4>
                    
                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>Ti√™u ƒë·ªÅ:</strong>
                            <span id="previewTitle"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>M√¥ t·∫£:</strong>
                            <span id="previewDescription"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>Danh m·ª•c:</strong>
                            <span id="previewCategory"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>M√¥n h·ªçc:</strong>
                            <span id="previewSubject"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>Tr√¨nh ƒë·ªô:</strong>
                            <span id="previewLevel"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>Ng√¥n ng·ªØ:</strong>
                            <span id="previewLanguage"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <strong>T·ª´ kh√≥a:</strong>
                            <span id="previewTags"></span>
                        </div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 30px; border-radius: 12px;">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; font-weight: 700;">üìÅ Danh s√°ch file</h4>
                    <div id="previewFiles"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary" onclick="goToStep(2)">
                        <span>‚Üê</span> S·ª≠a th√¥ng tin
                    </button>
                    <button class="btn-primary" onclick="submitUpload()">
                        <span>‚¨ÜÔ∏è</span> T·∫£i l√™n
                    </button>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div class="upload-section" id="uploadStep4" style="display: none;">
                <div class="success-animation">
                    <div class="success-icon">‚úÖ</div>
                    <h3 class="success-title">T·∫£i l√™n th√†nh c√¥ng!</h3>
                    <p class="success-message">
                        T√†i li·ªáu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n v√† ƒëang ch·ªù ph√™ duy·ªát.
                        <br>
                        Ch√∫ng t√¥i s·∫Ω th√¥ng b√°o cho b·∫°n khi t√†i li·ªáu ƒë∆∞·ª£c duy·ªát.
                    </p>

                    <div class="uploaded-files-list" id="successFilesList">
                        <!-- Files will be listed here -->
                    </div>

                    <!-- Upload Queue Status -->
                    <div class="upload-queue-status" id="uploadQueueStatus" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50; font-weight: 700;">üìä Tr·∫°ng th√°i t·∫£i l√™n</h4>
                        <div id="queueList"></div>
                    </div>

                    <div class="action-buttons" style="max-width: 500px; margin: 0 auto;">
                        <button class="btn-secondary" onclick="window.location.href='./my-documents.html'">
                            <span>üìÑ</span> Xem t√†i li·ªáu c·ªßa t√¥i
                        </button>
                        <button class="btn-primary" onclick="resetUpload()">
                            <span>‚¨ÜÔ∏è</span> T·∫£i l√™n ti·∫øp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>üìö DocShare</h4>
                    <p>N·ªÅn t·∫£ng chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p h√†ng ƒë·∫ßu d√†nh cho sinh vi√™n Vi·ªát Nam</p>
                </div>
                <div class="footer-section">
                    <h4>Li√™n k·∫øt nhanh</h4>
                    <ul>
                        <li><a href="./home.html">Dashboard</a></li>
                        <li><a href="./my-documents.html">T√†i li·ªáu c·ªßa t√¥i</a></li>
                        <li><a href="./upload.html">T·∫£i l√™n</a></li>
                        <li><a href="./profile.html">C√†i ƒë·∫∑t</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 DocShare. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top -->
    <button id="backToTop" class="back-to-top" onclick="scrollToTop()">‚Üë</button>

    <!-- Scripts -->
    <script src="../main.js"></script>
    <script src="../header-auth.js"></script>
    <script>
        // ============================================================================
        // GLOBAL VARIABLES & CONFIGURATION
        // ============================================================================
        let selectedFiles = [];
        let currentStep = 1;
        let uploadController = null;
        let autoSaveTimer = null;
        let uploadQueue = [];

        // MAX_FILE_SIZE already defined in main.js
        const ALLOWED_MIME_TYPES = [
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-powerpoint',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'text/plain'
        ];

        const ERROR_MESSAGES = {
            'FILE_TOO_LARGE': 'File qu√° l·ªõn. T·ªëi ƒëa 50MB',
            'INVALID_FORMAT': 'ƒê·ªãnh d·∫°ng file kh√¥ng h·ª£p l·ªá',
            'UPLOAD_FAILED': 'T·∫£i l√™n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i',
            'NETWORK_ERROR': 'L·ªói k·∫øt n·ªëi m·∫°ng',
            'UNAUTHORIZED': 'Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i',
            'FILE_CORRUPT': 'File b·ªã l·ªói ho·∫∑c kh√¥ng th·ªÉ ƒë·ªçc',
            'DUPLICATE_FILE': 'File ƒë√£ ƒë∆∞·ª£c ch·ªçn',
            'SERVER_ERROR': 'L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau'
        };

        // API Configuration - THAY ƒê·ªîI THEO BACKEND C·ª¶A B·∫†N
        const API_CONFIG = {
            BASE_URL: 'http://localhost:3000/api',
            ENDPOINTS: {
                UPLOAD: '/documents',
                VALIDATE: '/documents/validate',
                CHECK_DUPLICATE: '/documents/check-duplicate'
            }
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthAndInit();
            setupUploadArea();
            loadDraftIfExists();
            loadCategoriesAndSubjects();
        });

        function checkAuthAndInit() {
            const user = getUser();
            const token = localStorage.getItem('token');

            console.log('üîê Auth check:', { user: user ? user.email : 'None', token: token ? 'Present' : 'Missing' });

            if (!user || !token) {
                showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i l√™n t√†i li·ªáu', 'info');
                setTimeout(() => {
                    window.location.href = '../login.html?redirect=upload';
                }, 1500);
                return;
            }

            updateUserInfo(user);
        }

        function updateUserInfo(user) {
            const userNameHeader = document.getElementById('userNameHeader');
            const dropdownUserEmail = document.getElementById('dropdownUserEmail');

            if (userNameHeader) {
                const displayName = user.ho_ten || user.email.split('@')[0];
                userNameHeader.textContent = displayName.length > 20 ? displayName.substring(0, 20) + '...' : displayName;
            }

            if (dropdownUserEmail) {
                dropdownUserEmail.textContent = user.email;
            }
        }

        // Load categories and subjects from API
        async function loadCategoriesAndSubjects() {
            try {
                // Load categories
                const categoriesResponse = await fetch('http://localhost:3000/api/categories/danhmuc');
                if (categoriesResponse.ok) {
                    const categories = await categoriesResponse.json();
                    const categorySelect = document.getElementById('docCategory');
                    if (categorySelect && categories.length > 0) {
                        categorySelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.ma_danh_muc;
                            option.textContent = cat.ten_danh_muc;
                            categorySelect.appendChild(option);
                        });
                    }
                }

                // Load subjects
                const subjectsResponse = await fetch('http://localhost:3000/api/categories/monhoc');
                if (subjectsResponse.ok) {
                    const subjects = await subjectsResponse.json();
                    const subjectSelect = document.getElementById('docSubject');
                    if (subjectSelect && subjects.length > 0) {
                        // Convert input to select if needed
                        if (subjectSelect.tagName === 'INPUT') {
                            const newSelect = document.createElement('select');
                            newSelect.id = 'docSubject';
                            newSelect.required = true;
                            newSelect.setAttribute('onchange', 'saveDraftAuto()');
                            newSelect.innerHTML = '<option value="">Ch·ªçn m√¥n h·ªçc</option>';
                            subjects.forEach(subj => {
                                const option = document.createElement('option');
                                option.value = subj.ma_mon_hoc;
                                option.textContent = subj.ten_mon_hoc;
                                newSelect.appendChild(option);
                            });
                            subjectSelect.parentNode.replaceChild(newSelect, subjectSelect);
                        } else {
                            subjectSelect.innerHTML = '<option value="">Ch·ªçn m√¥n h·ªçc</option>';
                            subjects.forEach(subj => {
                                const option = document.createElement('option');
                                option.value = subj.ma_mon_hoc;
                                option.textContent = subj.ten_mon_hoc;
                                subjectSelect.appendChild(option);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading categories/subjects:', error);
            }
        }

        // ============================================================================
        // UPLOAD AREA SETUP
        // ============================================================================
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            fileInput.addEventListener('change', handleFileSelect);

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            uploadArea.addEventListener('click', (e) => {
                if (e.target === uploadArea || uploadArea.contains(e.target)) {
                    if (!e.target.classList.contains('file-input-hidden')) {
                        fileInput.click();
                    }
                }
            });
        }

        // ============================================================================
        // FILE HANDLING
        // ============================================================================
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        async function handleFiles(files) {
            let validFiles = [];
            let errors = [];

            for (const file of files) {
                // Validate file type
                if (!ALLOWED_MIME_TYPES.includes(file.type)) {
                    errors.push(`${file.name}: ${ERROR_MESSAGES.INVALID_FORMAT}`);
                    continue;
                }

                // Validate file size
                if (file.size > MAX_FILE_SIZE) {
                    errors.push(`${file.name}: ${ERROR_MESSAGES.FILE_TOO_LARGE}`);
                    continue;
                }

                // Check duplicate
                if (selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    errors.push(`${file.name}: ${ERROR_MESSAGES.DUPLICATE_FILE}`);
                    continue;
                }

                // Validate file integrity
                const isValid = await validateFileIntegrity(file);
                if (!isValid) {
                    errors.push(`${file.name}: ${ERROR_MESSAGES.FILE_CORRUPT}`);
                    continue;
                }

                validFiles.push(file);
            }

            // Show errors
            if (errors.length > 0) {
                showToast(errors.join('\n'), 'error');
            }

            // Add valid files
            if (validFiles.length > 0) {
                selectedFiles = [...selectedFiles, ...validFiles];
                displayFiles();
                showToast(`ƒê√£ th√™m ${validFiles.length} file`, 'success');
            }
        }

        async function validateFileIntegrity(file) {
            try {
                if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const header = new Uint8Array(arrayBuffer.slice(0, 5));
                    const pdfHeader = String.fromCharCode(...header);
                    return pdfHeader === '%PDF-';
                }
                // Add more validation for other file types if needed
                return true;
            } catch (error) {
                console.error('File validation error:', error);
                return false;
            }
        }

        function displayFiles() {
            const filesPreview = document.getElementById('filesPreview');
            const filesList = document.getElementById('filesList');
            const fileCount = document.getElementById('fileCount');
            const btnNext = document.getElementById('btnNextStep1');

            if (selectedFiles.length === 0) {
                filesPreview.style.display = 'none';
                btnNext.disabled = true;
                return;
            }

            filesPreview.style.display = 'block';
            fileCount.textContent = selectedFiles.length;
            btnNext.disabled = false;

            filesList.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-preview-item" id="file-${index}">
                    <div class="file-icon-preview">${getFileIcon(file.type)}</div>
                    <div class="file-info-preview">
                        <div class="file-name-preview">${file.name}</div>
                        <div class="file-size-preview">${formatFileSize(file.size)}</div>
                        <div class="file-progress" id="progress-${index}" style="display: none;">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="progressBar-${index}"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progressText-${index}">0%</span>
                                <span id="progressSpeed-${index}"></span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${file.type === 'application/pdf' ? `
                            <button class="file-preview-btn" onclick="previewFile(${index})">
                                üëÅÔ∏è Xem
                            </button>
                        ` : ''}
                        <button class="file-remove-btn" onclick="removeFile(${index})">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFiles();
            showToast('ƒê√£ x√≥a file', 'info');
        }

        function clearFiles() {
            if (selectedFiles.length === 0) return;
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ c√°c file ƒë√£ ch·ªçn?')) {
                selectedFiles = [];
                displayFiles();
                document.getElementById('fileInput').value = '';
                showToast('ƒê√£ x√≥a t·∫•t c·∫£ file', 'info');
            }
        }

        // ============================================================================
        // FILE PREVIEW
        // ============================================================================
        function previewFile(index) {
            const file = selectedFiles[index];
            
            if (file.type === 'application/pdf') {
                const fileURL = URL.createObjectURL(file);
                const modal = document.getElementById('previewModal');
                const container = document.getElementById('previewContainer');
                
                container.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">${file.name}</h3>
                    <iframe src="${fileURL}" style="width: 100%; height: 70vh; border: none; border-radius: 8px;"></iframe>
                `;
                
                modal.classList.add('show');
            } else {
                showToast('Ch·ªâ h·ªó tr·ª£ xem tr∆∞·ªõc file PDF', 'info');
            }
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('show');
        }

        // ============================================================================
        // STEP NAVIGATION
        // ============================================================================
        function goToStep(step) {
            // Validate current step
            if (currentStep === 1 && step === 2) {
                if (selectedFiles.length === 0) {
                    showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file', 'error');
                    return;
                }
            }

            if (currentStep === 2 && step === 3) {
                if (!validateForm()) {
                    return;
                }
                updatePreview();
            }

            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`uploadStep${i}`).style.display = 'none';
                document.getElementById(`step${i}`).classList.remove('active', 'completed');
            }

            // Show current step
            document.getElementById(`uploadStep${step}`).style.display = 'block';
            document.getElementById(`step${step}`).classList.add('active');

            // Mark previous steps as completed
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }

            currentStep = step;
            scrollToTop();
        }

        // ============================================================================
        // FORM VALIDATION
        // ============================================================================
        function validateForm() {
            const title = document.getElementById('docTitle').value.trim();
            const description = document.getElementById('docDescription').value.trim();
            const category = document.getElementById('docCategory').value;
            const agree = document.getElementById('docAgree').checked;

            if (!title) {
                showToast('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ t√†i li·ªáu', 'error');
                document.getElementById('docTitle').focus();
                return false;
            }

            if (title.length < 10) {
                showToast('Ti√™u ƒë·ªÅ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±', 'error');
                document.getElementById('docTitle').focus();
                return false;
            }

            if (!description) {
                showToast('Vui l√≤ng nh·∫≠p m√¥ t·∫£ t√†i li·ªáu', 'error');
                document.getElementById('docDescription').focus();
                return false;
            }

            if (description.length < 20) {
                showToast('M√¥ t·∫£ ph·∫£i c√≥ √≠t nh·∫•t 20 k√Ω t·ª±', 'error');
                document.getElementById('docDescription').focus();
                return false;
            }

            if (!category) {
                showToast('Vui l√≤ng ch·ªçn danh m·ª•c', 'error');
                document.getElementById('docCategory').focus();
                return false;
            }

            if (!agree) {
                showToast('Vui l√≤ng x√°c nh·∫≠n ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng', 'error');
                return false;
            }

            return true;
        }

        // ============================================================================
        // PREVIEW UPDATE
        // ============================================================================
        function updatePreview() {
            const categoryMap = {
                'tech': 'üñ•Ô∏è C√¥ng ngh·ªá th√¥ng tin',
                'science': 'üî¨ Khoa h·ªçc t·ª± nhi√™n',
                'business': 'üíº Kinh t·∫ø & Kinh doanh',
                'language': 'üåê Ng√¥n ng·ªØ',
                'social': 'üìñ Khoa h·ªçc x√£ h·ªôi',
                'engineering': '‚öôÔ∏è K·ªπ thu·∫≠t',
                'medicine': '‚öïÔ∏è Y d∆∞·ª£c',
                'art': 'üé® Ngh·ªá thu·∫≠t'
            };

            const levelMap = {
                'beginner': 'C∆° b·∫£n',
                'intermediate': 'Trung c·∫•p',
                'advanced': 'N√¢ng cao'
            };

            const languageMap = {
                'vi': 'Ti·∫øng Vi·ªát',
                'en': 'English',
                'both': 'Song ng·ªØ'
            };

            document.getElementById('previewTitle').textContent = document.getElementById('docTitle').value;
            document.getElementById('previewDescription').textContent = document.getElementById('docDescription').value;
            document.getElementById('previewCategory').textContent = categoryMap[document.getElementById('docCategory').value] || '-';
            document.getElementById('previewSubject').textContent = document.getElementById('docSubject').value || '-';
            document.getElementById('previewLevel').textContent = levelMap[document.getElementById('docLevel').value] || '-';
            document.getElementById('previewLanguage').textContent = languageMap[document.getElementById('docLanguage').value];
            document.getElementById('previewTags').textContent = document.getElementById('docTags').value || '-';

            const previewFiles = document.getElementById('previewFiles');
            previewFiles.innerHTML = selectedFiles.map(file => `
                <div class="uploaded-file-item">
                    <span style="font-size: 1.5rem;">${getFileIcon(file.type)}</span>
                    <span style="flex: 1; font-weight: 600;">${file.name}</span>
                    <span style="color: #666; font-size: 0.9rem;">${formatFileSize(file.size)}</span>
                </div>
            `).join('');
        }

        // ============================================================================
        // UPLOAD FUNCTIONALITY
        // ============================================================================
        async function submitUpload() {
            uploadController = new AbortController();
            
            showLoading();
            updateLoadingText('ƒêang chu·∫©n b·ªã t·∫£i l√™n...');

            try {
                // Upload files in queue
                await uploadFilesInQueue();
                
                hideLoading();
                displaySuccess();
                goToStep(4);
                clearDraft();
                
            } catch (error) {
                hideLoading();
                console.error('Upload error:', error);
                
                if (error.name === 'AbortError') {
                    showToast('ƒê√£ h·ªßy t·∫£i l√™n', 'info');
                } else {
                    const errorMsg = ERROR_MESSAGES[error.message] || ERROR_MESSAGES.UPLOAD_FAILED;
                    showToast(errorMsg, 'error');
                }
            }
        }

        async function uploadFilesInQueue() {
            uploadQueue = selectedFiles.map((file, index) => ({
                file,
                index,
                status: 'pending',
                progress: 0
            }));

            for (let item of uploadQueue) {
                item.status = 'uploading';
                await uploadSingleFile(item);
            }
        }

        async function uploadSingleFile(queueItem) {
            const { file, index } = queueItem;
            
            return new Promise((resolve, reject) => {
                // Validate token
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('‚ùå No token found in localStorage');
                    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'error');
                    setTimeout(() => {
                        window.location.href = '../login.html?redirect=upload';
                    }, 2000);
                    reject(new Error('NO_TOKEN'));
                    return;
                }

                // Validate required fields
                const title = document.getElementById('docTitle').value.trim();
                const subjectId = document.getElementById('docSubject').value;
                
                if (!title) {
                    showToast('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ', 'error');
                    reject(new Error('MISSING_TITLE'));
                    return;
                }
                
                if (!subjectId || subjectId === '' || subjectId === '0') {
                    showToast('Vui l√≤ng ch·ªçn m√¥n h·ªçc', 'error');
                    reject(new Error('MISSING_SUBJECT'));
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                
                // Add metadata - using backend field names
                formData.append('tieu_de', title);
                formData.append('mo_ta', document.getElementById('docDescription').value.trim());
                formData.append('ma_danh_muc', document.getElementById('docCategory').value || '');
                formData.append('ma_mon_hoc', subjectId);

                console.log('Upload data:', {
                    tieu_de: title,
                    ma_mon_hoc: subjectId,
                    file: file.name
                });

                const xhr = new XMLHttpRequest();
                
                // Progress tracking
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        updateFileProgress(index, percent, e.loaded, e.total);
                        queueItem.progress = percent;
                    }
                });

                // Success
                xhr.addEventListener('load', () => {
                    console.log('Upload response:', xhr.status, xhr.responseText);
                    
                    if (xhr.status === 200 || xhr.status === 201) {
                        queueItem.status = 'completed';
                        updateFileProgress(index, 100);
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log('Upload success:', response);
                            resolve(response);
                        } catch (e) {
                            console.error('Failed to parse response:', e);
                            resolve({ success: true });
                        }
                    } else {
                        queueItem.status = 'failed';
                        console.error('Upload failed:', xhr.status, xhr.responseText);
                        try {
                            const error = JSON.parse(xhr.responseText);
                            showToast(error.message || 'Upload th·∫•t b·∫°i', 'error');
                        } catch (e) {
                            showToast('Upload th·∫•t b·∫°i: ' + xhr.status, 'error');
                        }
                        reject(new Error('UPLOAD_FAILED'));
                    }
                });

                // Error
                xhr.addEventListener('error', (e) => {
                    queueItem.status = 'failed';
                    console.error('Network error:', e);
                    showToast('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra server c√≥ ƒëang ch·∫°y kh√¥ng.', 'error');
                    reject(new Error('NETWORK_ERROR'));
                });

                xhr.addEventListener('abort', () => {
                    queueItem.status = 'cancelled';
                    reject(new Error('AbortError'));
                });

                // Upload to real API endpoint
                const uploadUrl = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.UPLOAD}`;
                console.log('Upload URL:', uploadUrl);
                console.log('Token:', token ? 'Present' : 'Missing');
                
                // DEVELOPMENT: Uncomment below to simulate upload
                // simulateFileUpload(index).then(resolve).catch(reject);
                // return;

                // PRODUCTION CODE:
                xhr.open('POST', uploadUrl);
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
            });
        }

        // Simulate upload for development
        function simulateFileUpload(index) {
            return new Promise((resolve) => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    updateFileProgress(index, progress);
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        resolve({ success: true });
                    }
                }, 200);
            });
        }

        function updateFileProgress(index, percent, loaded, total) {
            const progressContainer = document.getElementById(`progress-${index}`);
            const progressBar = document.getElementById(`progressBar-${index}`);
            const progressText = document.getElementById(`progressText-${index}`);
            const progressSpeed = document.getElementById(`progressSpeed-${index}`);

            if (progressContainer) {
                progressContainer.style.display = 'block';
            }

            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }

            if (progressText) {
                progressText.textContent = `${percent}%`;
            }

            if (progressSpeed && loaded && total) {
                const speedMBps = ((loaded / 1024 / 1024) / 2).toFixed(2); // Rough estimate
                progressSpeed.textContent = `${speedMBps} MB/s`;
            }

            updateLoadingText(`ƒêang t·∫£i l√™n file ${index + 1}/${selectedFiles.length} (${percent}%)`);
        }

        function cancelUpload() {
            if (uploadController) {
                uploadController.abort();
                uploadController = null;
                showToast('ƒê√£ h·ªßy t·∫£i l√™n', 'info');
            }
        }

        // ============================================================================
        // SUCCESS DISPLAY
        // ============================================================================
        function displaySuccess() {
            const successList = document.getElementById('successFilesList');
            successList.innerHTML = `
                <h4 style="margin-bottom: 15px; color: #2c3e50; font-weight: 700;">
                    ƒê√£ t·∫£i l√™n ${selectedFiles.length} file:
                </h4>
                ${selectedFiles.map(file => `
                    <div class="uploaded-file-item">
                        <span style="font-size: 1.5rem;">${getFileIcon(file.type)}</span>
                        <span style="flex: 1; font-weight: 600;">${file.name}</span>
                        <span style="color: #27ae60; font-weight: 700;">‚úì</span>
                    </div>
                `).join('')}
            `;

            // Show upload queue status if multiple files
            if (uploadQueue.length > 1) {
                const queueStatus = document.getElementById('uploadQueueStatus');
                const queueList = document.getElementById('queueList');
                
                queueList.innerHTML = uploadQueue.map(item => `
                    <div class="queue-item">
                        <span>${item.file.name}</span>
                        <span class="queue-status ${item.status}">${getQueueStatusText(item.status)}</span>
                    </div>
                `).join('');
                
                queueStatus.style.display = 'block';
            }
        }

        function getQueueStatusText(status) {
            const statusMap = {
                'pending': 'ƒêang ch·ªù',
                'uploading': 'ƒêang t·∫£i',
                'completed': 'Ho√†n th√†nh',
                'failed': 'Th·∫•t b·∫°i',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        // ============================================================================
        // DRAFT AUTO-SAVE
        // ============================================================================
        function saveDraftAuto() {
            // Clear existing timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }

            // Set new timer (save after 2 seconds of inactivity)
            autoSaveTimer = setTimeout(() => {
                saveDraft();
            }, 2000);
        }

        function saveDraft() {
            const draft = {
                title: document.getElementById('docTitle').value,
                description: document.getElementById('docDescription').value,
                category: document.getElementById('docCategory').value,
                subject: document.getElementById('docSubject').value,
                level: document.getElementById('docLevel').value,
                language: document.getElementById('docLanguage').value,
                tags: document.getElementById('docTags').value,
                timestamp: Date.now()
            };

            // Only save if there's actual content
            if (draft.title || draft.description) {
                localStorage.setItem('docShareUploadDraft', JSON.stringify(draft));
                showDraftIndicator();
            }
        }

        function loadDraft() {
            const draftStr = localStorage.getItem('docShareUploadDraft');
            
            if (!draftStr) {
                showToast('Kh√¥ng c√≥ b·∫£n nh√°p n√†o', 'info');
                return;
            }

            const draft = JSON.parse(draftStr);
            
            if (confirm('T√¨m th·∫•y b·∫£n nh√°p ƒë√£ l∆∞u. B·∫°n c√≥ mu·ªën kh√¥i ph·ª•c kh√¥ng?')) {
                document.getElementById('docTitle').value = draft.title || '';
                document.getElementById('docDescription').value = draft.description || '';
                document.getElementById('docCategory').value = draft.category || '';
                document.getElementById('docSubject').value = draft.subject || '';
                document.getElementById('docLevel').value = draft.level || '';
                document.getElementById('docLanguage').value = draft.language || 'vi';
                document.getElementById('docTags').value = draft.tags || '';

                // Update character counters
                updateCharCount('docTitle', 'titleCount', 200);
                updateCharCount('docDescription', 'descCount', 1000);

                showToast('ƒê√£ kh√¥i ph·ª•c b·∫£n nh√°p', 'success');
                
                // Go to step 2 if we're on step 1 and have files
                if (currentStep === 1 && selectedFiles.length > 0) {
                    goToStep(2);
                }
            }
        }

        function loadDraftIfExists() {
            const draftStr = localStorage.getItem('docShareUploadDraft');
            if (draftStr) {
                const draft = JSON.parse(draftStr);
                const daysSinceSave = (Date.now() - draft.timestamp) / (1000 * 60 * 60 * 24);
                
                // Auto-prompt if draft is less than 7 days old
                if (daysSinceSave < 7) {
                    setTimeout(() => {
                        if (confirm('B·∫°n c√≥ b·∫£n nh√°p ch∆∞a ho√†n th√†nh. Ti·∫øp t·ª•c ch·ªânh s·ª≠a?')) {
                            loadDraft();
                        }
                    }, 1000);
                }
            }
        }

        function clearDraft() {
            localStorage.removeItem('docShareUploadDraft');
        }

        function showDraftIndicator() {
            const indicator = document.getElementById('draftIndicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // ============================================================================
        // RESET UPLOAD
        // ============================================================================
        function resetUpload() {
            selectedFiles = [];
            uploadQueue = [];
            currentStep = 1;
            
            document.getElementById('documentForm').reset();
            document.getElementById('fileInput').value = '';
            
            displayFiles();
            goToStep(1);
            
            showToast('S·∫µn s√†ng t·∫£i l√™n t√†i li·ªáu m·ªõi', 'info');
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function updateCharCount(inputId, countId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(countId);
            const length = input.value.length;
            
            counter.textContent = `${length}/${maxLength} k√Ω t·ª±`;
            
            if (length > maxLength * 0.9) {
                counter.classList.add('danger');
                counter.classList.remove('warning');
            } else if (length > maxLength * 0.7) {
                counter.classList.add('warning');
                counter.classList.remove('danger');
            } else {
                counter.classList.remove('warning', 'danger');
            }
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'üìï';
            if (type.includes('word')) return 'üìò';
            if (type.includes('powerpoint') || type.includes('presentation')) return 'üìä';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'üìó';
            if (type.includes('text')) return 'üìÑ';
            return 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function updateLoadingText(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        // ============================================================================
        // UI CONTROLS
        // ============================================================================
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function toggleMobileMenu() {
            const nav = document.querySelector('.nav');
            if (nav) {
                nav.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdownMenu');
            const dropdownBtn = document.querySelector('.user-dropdown-btn');
            
            if (dropdown && dropdownBtn) {
                if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Close preview modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePreviewModal();
            }
        });

        // Prevent form submission on Enter
        document.getElementById('documentForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
        });

        // Warn user before leaving if files are selected
        window.addEventListener('beforeunload', function(e) {
            if (selectedFiles.length > 0 && currentStep < 4) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>