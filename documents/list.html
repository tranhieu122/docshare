<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kh√°m ph√° t√†i li·ªáu - DocShare">
    <meta name="keywords" content="t√†i li·ªáu h·ªçc t·∫≠p, chia s·∫ª t√†i li·ªáu, sinh vi√™n, ƒë·∫°i h·ªçc">
    <meta name="author" content="DocShare Team">
    <title>Kh√°m ph√° t√†i li·ªáu | DocShare</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
</head>
<body>
    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <span id="toastMessage"></span>
        <button onclick="closeToast()" class="toast-close">&times;</button>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i...</p>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="../index.html" style="text-decoration: none; color: inherit;">
                    <h1>üìö DocShare</h1>
                </a>
                <span class="logo-subtitle">H·ªçc t·∫≠p & Chia s·∫ª</span>
            </div>
            <nav class="nav">
                <a href="../index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    Trang ch·ªß
                </a>
                <a href="./list.html" class="nav-link active">
                    <span class="nav-icon">üîç</span>
                    Kh√°m ph√°
                </a>
                <a href="../features.html" class="nav-link">
                    <span class="nav-icon">‚ú®</span>
                    T√≠nh nƒÉng
                </a>
                <a href="../about.html" class="nav-link">
                    <span class="nav-icon">‚ÑπÔ∏è</span>
                    V·ªÅ ch√∫ng t√¥i
                </a>
                <div class="nav-buttons" id="authButtons" style="display: none;">
                    <a href="../login.html" class="btn-login">
                        <span>üîë</span> ƒêƒÉng nh·∫≠p
                    </a>
                    <a href="../register.html" class="btn-register">
                        <span>üìù</span> ƒêƒÉng k√Ω
                    </a>
                </div>
                <!-- User Dropdown (ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p) -->
                <div class="nav-buttons" id="userSection">
                    <a href="../admin/dashboard.html" id="adminLink" class="btn-danger" style="display: none;">
                        <span>üîë</span> Qu·∫£n tr·ªã
                    </a>
                    <div class="user-dropdown">
                        <button class="user-dropdown-btn" onclick="toggleUserDropdown()">
                            <span class="user-icon">üë§</span>
                            <span id="userNameHeader">Ng∆∞·ªùi d√πng</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <span class="user-icon">üë§</span>
                                <span id="dropdownUserEmail" style="margin-left: 8px;">email@example.com</span>
                            </div>
                            <div class="dropdown-content-grid">
                                <a href="../sinhvien/home.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìä</span>
                                    <span>Dashboard</span>
                                </a>
                                <a href="../sinhvien/my-documents.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìÑ</span>
                                    <span>T√†i li·ªáu c·ªßa t√¥i</span>
                                </a>
                                <a href="../sinhvien/upload.html" class="dropdown-item">
                                    <span class="dropdown-icon">‚¨ÜÔ∏è</span>
                                    <span>T·∫£i l√™n</span>
                                </a>
                                <a href="../sinhvien/profile.html" class="dropdown-item">
                                    <span class="dropdown-icon">‚öôÔ∏è</span>
                                    <span>C√†i ƒë·∫∑t</span>
                                </a>
                            </div>
                            <div class="dropdown-divider"></div>
                            <button onclick="logout()" class="dropdown-item dropdown-logout">
                                <span class="dropdown-icon">üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Search & Filter Section -->
    <section style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px 0; margin-bottom: 40px;">
        <div class="container">
            <h1 style="color: white; text-align: center; margin-bottom: 30px; font-size: 2.5rem;">üîç Kh√°m ph√° t√†i li·ªáu</h1>
            
            <!-- Search Bar -->
            <div style="max-width: 800px; margin: 0 auto 30px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t√†i li·ªáu..." 
                        style="flex: 1; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1rem;"
                        onkeypress="if(event.key === 'Enter') searchDocuments()">
                    <button onclick="searchDocuments()" class="btn" style="background: white; color: #667eea; padding: 15px 30px;">
                        üîç T√¨m ki·∫øm
                    </button>
                </div>
            </div>

            <!-- Filter Chips -->
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button class="filter-chip-light active" data-filter="all" onclick="filterDocuments('all')">
                    üìö T·∫•t c·∫£
                </button>
                <button class="filter-chip-light" data-filter="category" onclick="toggleCategoryFilter()">
                    üè∑Ô∏è Danh m·ª•c
                </button>
                <button class="filter-chip-light" data-filter="subject" onclick="toggleSubjectFilter()">
                    üìñ M√¥n h·ªçc
                </button>
                <button class="filter-chip-light" data-filter="sort" onclick="toggleSortFilter()">
                    ‚ö° S·∫Øp x·∫øp
                </button>
            </div>

            <!-- Dropdown Filters -->
            <div id="categoryFilterDropdown" style="display: none; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <select id="categorySelect" class="form-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid white;" onchange="applyCategoryFilter()">
                    <option value="">-- Ch·ªçn danh m·ª•c --</option>
                </select>
            </div>

            <div id="subjectFilterDropdown" style="display: none; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <select id="subjectSelect" class="form-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid white;" onchange="applySubjectFilter()">
                    <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                </select>
            </div>

            <div id="sortFilterDropdown" style="display: none; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <select id="sortSelect" class="form-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid white;" onchange="applySortFilter()">
                    <option value="newest">üÜï M·ªõi nh·∫•t</option>
                    <option value="popular">üî• Ph·ªï bi·∫øn nh·∫•t</option>
                    <option value="downloads">‚¨áÔ∏è Nhi·ªÅu l∆∞·ª£t t·∫£i</option>
                    <option value="rating">‚≠ê ƒê√°nh gi√° cao</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Documents Grid -->
    <section class="dashboard">
        <div class="container">
            <!-- Result Info -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="resultTitle" style="color: #2c3e50; margin: 0;">üìö T·∫•t c·∫£ t√†i li·ªáu</h2>
                <span id="resultCount" style="color: #666; font-size: 0.9rem;">ƒêang t·∫£i...</span>
            </div>

            <!-- Documents Grid -->
            <div id="documentsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px;">
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                    <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                    <p style="color: #666;">ƒêang t·∫£i t√†i li·ªáu...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 40px;">
                <!-- Pagination will be generated here -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>üìö DocShare</h4>
                    <p>N·ªÅn t·∫£ng chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p h√†ng ƒë·∫ßu cho sinh vi√™n Vi·ªát Nam</p>
                    <div class="footer-social">
                        <a href="#" title="Facebook">üìò</a>
                        <a href="#" title="Twitter">üê¶</a>
                        <a href="#" title="Instagram">üì∑</a>
                    </div>
                </div>

                <div class="footer-section">
                    <h4>Li√™n k·∫øt nhanh</h4>
                    <ul>
                        <li><a href="../index.html">Trang ch·ªß</a></li>
                        <li><a href="./list.html">Kh√°m ph√°</a></li>
                        <li><a href="../sinhvien/upload.html">T·∫£i l√™n</a></li>
                        <li><a href="../sinhvien/my-documents.html">T√†i li·ªáu c·ªßa t√¥i</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>H·ªó tr·ª£</h4>
                    <ul>
                        <li><a href="#">Trung t√¢m tr·ª£ gi√∫p</a></li>
                        <li><a href="#">Li√™n h·ªá</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Ph√°p l√Ω</h4>
                    <ul>
                        <li><a href="#">ƒêi·ªÅu kho·∫£n</a></li>
                        <li><a href="#">B·∫£o m·∫≠t</a></li>
                        <li><a href="#">B·∫£n quy·ªÅn</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 DocShare. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top -->
    <button id="backToTop" class="back-to-top" onclick="scrollToTop()">‚Üë</button>

    <!-- Scripts -->
    <script src="../main.js"></script>
    <script src="../header-auth.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000/api';
        let allDocuments = [];
        let filteredDocuments = [];
        let currentPage = 1;
        const itemsPerPage = 12;
        let currentFilter = {
            search: '',
            category: '',
            subject: '',
            sort: 'newest'
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadSubjects();
            loadDocuments();
            
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('search')) {
                document.getElementById('searchInput').value = urlParams.get('search');
                currentFilter.search = urlParams.get('search');
            }
            if (urlParams.has('category')) {
                currentFilter.category = urlParams.get('category');
            }
            if (urlParams.has('subject')) {
                currentFilter.subject = urlParams.get('subject');
            }
        });

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                if (response.ok) {
                    const categories = await response.json();
                    const select = document.getElementById('categorySelect');
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.ma_danh_muc;
                        option.textContent = cat.ten_danh_muc;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load subjects
        async function loadSubjects() {
            try {
                const response = await fetch(`${API_BASE}/subjects`);
                if (response.ok) {
                    const subjects = await response.json();
                    const select = document.getElementById('subjectSelect');
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.ma_mon_hoc;
                        option.textContent = subject.ten_mon_hoc;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        // Load documents
        async function loadDocuments() {
            showLoading();
            try {
                let url = `${API_BASE}/documents`;
                const params = new URLSearchParams();
                
                if (currentFilter.search) {
                    url = `${API_BASE}/documents/search`;
                    params.append('q', currentFilter.search);
                }
                if (currentFilter.category) {
                    params.append('category', currentFilter.category);
                }
                if (currentFilter.subject) {
                    params.append('subject', currentFilter.subject);
                }
                if (currentFilter.sort) {
                    params.append('sort', currentFilter.sort);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                
                if (response.ok) {
                    allDocuments = await response.json();
                    filteredDocuments = [...allDocuments];
                    displayDocuments();
                    updateResultInfo();
                } else {
                    showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i li·ªáu');
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                showError('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.');
            } finally {
                hideLoading();
            }
        }

        // Search documents
        function searchDocuments() {
            const searchValue = document.getElementById('searchInput').value.trim();
            currentFilter.search = searchValue;
            currentPage = 1;
            loadDocuments();
        }

        // Filter documents
        function filterDocuments(type) {
            // Update active chip
            document.querySelectorAll('.filter-chip-light').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');

            if (type === 'all') {
                currentFilter = { search: '', category: '', subject: '', sort: 'newest' };
                document.getElementById('searchInput').value = '';
                document.getElementById('categorySelect').value = '';
                document.getElementById('subjectSelect').value = '';
                document.getElementById('sortSelect').value = 'newest';
                currentPage = 1;
                loadDocuments();
            }
        }

        // Toggle filters
        function toggleCategoryFilter() {
            const dropdown = document.getElementById('categoryFilterDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            document.getElementById('subjectFilterDropdown').style.display = 'none';
            document.getElementById('sortFilterDropdown').style.display = 'none';
        }

        function toggleSubjectFilter() {
            const dropdown = document.getElementById('subjectFilterDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            document.getElementById('categoryFilterDropdown').style.display = 'none';
            document.getElementById('sortFilterDropdown').style.display = 'none';
        }

        function toggleSortFilter() {
            const dropdown = document.getElementById('sortFilterDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            document.getElementById('categoryFilterDropdown').style.display = 'none';
            document.getElementById('subjectFilterDropdown').style.display = 'none';
        }

        // Apply filters
        function applyCategoryFilter() {
            currentFilter.category = document.getElementById('categorySelect').value;
            currentPage = 1;
            loadDocuments();
        }

        function applySubjectFilter() {
            currentFilter.subject = document.getElementById('subjectSelect').value;
            currentPage = 1;
            loadDocuments();
        }

        function applySortFilter() {
            currentFilter.sort = document.getElementById('sortSelect').value;
            currentPage = 1;
            loadDocuments();
        }

        // Display documents
        function displayDocuments() {
            const grid = document.getElementById('documentsGrid');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageDocuments = filteredDocuments.slice(startIndex, endIndex);

            if (pageDocuments.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">üì≠</div>
                        <h3 style="color: #666; margin-bottom: 10px;">Kh√¥ng t√¨m th·∫•y t√†i li·ªáu</h3>
                        <p style="color: #999;">Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c b·ªè b·ªô l·ªçc</p>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            grid.innerHTML = pageDocuments.map(doc => createDocumentCard(doc)).join('');
            createPagination();
        }

        // Create document card
        function createDocumentCard(doc) {
            const colors = ['#667eea', '#27ae60', '#e74c3c', '#f39c12', '#3498db', '#9b59b6'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            return `
                <div class="document-card" onclick="window.location.href='./detail.html?id=${doc.ma_tai_lieu}'">
                    <div class="document-icon" style="background: linear-gradient(135deg, ${randomColor} 0%, ${randomColor}dd 100%);">
                        üìÑ
                    </div>
                    <div class="document-content">
                        <h3 class="document-title">${doc.tieu_de || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'}</h3>
                        <p class="document-description">${(doc.mo_ta || 'Kh√¥ng c√≥ m√¥ t·∫£').substring(0, 80)}${(doc.mo_ta?.length > 80) ? '...' : ''}</p>
                        <div class="document-meta">
                            <span title="L∆∞·ª£t xem">üëÅÔ∏è ${formatNumber(doc.so_luot_xem || 0)}</span>
                            <span title="L∆∞·ª£t t·∫£i">‚¨áÔ∏è ${formatNumber(doc.so_luot_tai || 0)}</span>
                            <span title="ƒê√°nh gi√°">‚≠ê ${doc.rating || '-'}</span>
                        </div>
                        ${doc.ten_mon_hoc ? `<div class="document-tag">${doc.ten_mon_hoc}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Create pagination
        function createPagination() {
            const totalPages = Math.ceil(filteredDocuments.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            if (currentPage > 1) {
                html += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})">‚Äπ Tr∆∞·ªõc</button>`;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="padding: 10px;">...</span>`;
                }
            }

            // Next button
            if (currentPage < totalPages) {
                html += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})">Sau ‚Ä∫</button>`;
            }

            pagination.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayDocuments();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Update result info
        function updateResultInfo() {
            const count = document.getElementById('resultCount');
            const title = document.getElementById('resultTitle');
            
            let titleText = 'üìö T·∫•t c·∫£ t√†i li·ªáu';
            if (currentFilter.search) {
                titleText = `üîç K·∫øt qu·∫£ t√¨m ki·∫øm: "${currentFilter.search}"`;
            } else if (currentFilter.category) {
                titleText = 'üè∑Ô∏è T√†i li·ªáu theo danh m·ª•c';
            } else if (currentFilter.subject) {
                titleText = 'üìñ T√†i li·ªáu theo m√¥n h·ªçc';
            }
            
            title.textContent = titleText;
            count.textContent = `${filteredDocuments.length} t√†i li·ªáu`;
        }

        // Format number
        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Show error
        function showError(message) {
            const grid = document.getElementById('documentsGrid');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">‚ùå</div>
                    <h3 style="color: #e74c3c; margin-bottom: 10px;">${message}</h3>
                    <button class="btn" onclick="loadDocuments()">üîÑ Th·ª≠ l·∫°i</button>
                </div>
            `;
        }

        // Back to top
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show back to top button on scroll
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'block';
            } else {
                backToTop.style.display = 'none';
            }
        });
    </script>
</body>
</html>
