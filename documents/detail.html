<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Chi ti·∫øt t√†i li·ªáu - DocShare">
    <title>Chi ti·∫øt t√†i li·ªáu | DocShare</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <span id="toastMessage"></span>
        <button onclick="closeToast()" class="toast-close">&times;</button>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="../index.html" style="text-decoration: none; color: inherit;">
                    <h1>üìö DocShare</h1>
                </a>
                <span class="logo-subtitle">H·ªçc t·∫≠p & Chia s·∫ª</span>
            </div>
            <nav class="nav">
                <a href="../index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    Trang ch·ªß
                </a>
                <a href="./list.html" class="nav-link">
                    <span class="nav-icon">üîç</span>
                    Kh√°m ph√°
                </a>
                <div class="nav-buttons" id="authButtons">
                    <a href="../login.html" class="btn-login">
                        <span>üîë</span> ƒêƒÉng nh·∫≠p
                    </a>
                    <a href="../register.html" class="btn-register">
                        <span>üìù</span> ƒêƒÉng k√Ω
                    </a>
                </div>
                <!-- User Dropdown (ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p) -->
                <div class="nav-buttons" id="userSection" style="display: none;">
                    <a href="../admin/dashboard.html" id="adminLink" class="btn-danger" style="display: none;">
                        <span>üîë</span> Qu·∫£n tr·ªã
                    </a>
                    <div class="user-dropdown">
                        <button class="user-dropdown-btn" onclick="toggleUserDropdown()">
                            <span class="user-icon">üë§</span>
                            <span id="userNameHeader">Ng∆∞·ªùi d√πng</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="user-dropdown-menu" id="userDropdownMenu">
                            <div class="dropdown-header">
                                <span class="user-icon">üë§</span>
                                <span id="dropdownUserEmail" style="margin-left: 8px;">email@example.com</span>
                            </div>
                            <div class="dropdown-content-grid">
                                <a href="../sinhvien/home.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìä</span>
                                    <span>Dashboard</span>
                                </a>
                                <a href="../sinhvien/my-documents.html" class="dropdown-item">
                                    <span class="dropdown-icon">üìÑ</span>
                                    <span>T√†i li·ªáu c·ªßa t√¥i</span>
                                </a>
                                <a href="../sinhvien/upload.html" class="dropdown-item">
                                    <span class="dropdown-icon">‚¨ÜÔ∏è</span>
                                    <span>T·∫£i l√™n</span>
                                </a>
                                <a href="../sinhvien/profile.html" class="dropdown-item">
                                    <span class="dropdown-icon">‚öôÔ∏è</span>
                                    <span>C√†i ƒë·∫∑t</span>
                                </a>
                            </div>
                            <div class="dropdown-divider"></div>
                            <button onclick="logout()" class="dropdown-item dropdown-logout">
                                <span class="dropdown-icon">üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Document Detail -->
    <section class="dashboard">
        <div class="container">
            <div id="documentDetail"></div>

            <!-- Comments Section -->
            <div class="table-container" style="margin-top: 30px;">
                <h3>üí¨ B√¨nh lu·∫≠n (<span id="commentCount">0</span>)</h3>
                
                <!-- Comment Form -->
                <div id="commentFormContainer"></div>

                <!-- Comments List -->
                <div id="commentsList" style="margin-top: 20px;"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>üìö DocShare</h4>
                    <p>N·ªÅn t·∫£ng chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p h√†ng ƒë·∫ßu cho sinh vi√™n Vi·ªát Nam</p>
                    <div class="footer-social">
                        <a href="#" title="Facebook">üìò</a>
                        <a href="#" title="Twitter">üê¶</a>
                        <a href="#" title="Instagram">üì∑</a>
                    </div>
                </div>

                <div class="footer-section">
                    <h4>Li√™n k·∫øt nhanh</h4>
                    <ul>
                        <li><a href="../sinhvien/home.html">Trang ch·ªß</a></li>
                        <li><a href="../sinhvien/upload.html">T·∫£i l√™n</a></li>
                        <li><a href="../sinhvien/my-documents.html">T√†i li·ªáu</a></li>
                        <li><a href="../sinhvien/profile.html">H·ªì s∆°</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>H·ªó tr·ª£</h4>
                    <ul>
                        <li><a href="../help.html">Tr·ª£ gi√∫p</a></li>
                        <li><a href="../contact.html">Li√™n h·ªá</a></li>
                        <li><a href="../faq.html">FAQ</a></li>
                        <li><a href="../feedback.html">G√≥p √Ω</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Li√™n h·ªá</h4>
                    <ul class="footer-contact">
                        <li>üìß support@docshare.vn</li>
                        <li>üìû +84 123 456 789</li>
                        <li>üìç H√† N·ªôi, Vi·ªát Nam</li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 DocShare. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top -->
    <button id="backToTop" class="back-to-top" onclick="scrollToTop()">‚Üë</button>

    <script src="../main.js"></script>
    <script src="../header-auth.js"></script>
    <script>
        // Get URL parameter
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const documentId = getUrlParameter('id');
        let currentDocument = null;

        // ===================================
        // INITIALIZATION
        // ===================================

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadDocument();
            loadComments();
            setupEventListeners();
        });

        function checkAuthentication() {
            const user = getUser();
            const token = getToken();
            const authButtons = document.getElementById('authButtons');
            const userSection = document.getElementById('userSection');
            
            if (!user || !token) {
                // Show login buttons, hide user section
                if (authButtons) authButtons.style.display = 'flex';
                if (userSection) userSection.style.display = 'none';
            } else {
                // Hide login buttons, show user section
                if (authButtons) authButtons.style.display = 'none';
                if (userSection) userSection.style.display = 'flex';

                // Update dropdown user info
                const userNameHeader = document.getElementById('userNameHeader');
                if (userNameHeader) {
                    const displayName = user.ho_ten || user.email.split('@')[0];
                    userNameHeader.textContent = displayName.length > 20 ? displayName.substring(0, 20) + '...' : displayName;
                }

                const dropdownUserEmail = document.getElementById('dropdownUserEmail');
                if (dropdownUserEmail) {
                    dropdownUserEmail.textContent = user.email;
                }

                // Show admin link if user is admin
                if (user.chuc_vu === 'admin') {
                    const adminLink = document.getElementById('adminLink');
                    if (adminLink) {
                        adminLink.style.display = 'inline-flex';
                    }
                }
            }
        }

        function setupEventListeners() {
            window.addEventListener('scroll', function() {
                const backToTop = document.getElementById('backToTop');
                if (backToTop) {
                    backToTop.classList.toggle('show', window.pageYOffset > 300);
                }
            });
        }

        // ===================================
        // LOAD DOCUMENT
        // ===================================

        async function loadDocument() {
            if (!documentId) {
                window.location.href = './list.html';
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_URL}/documents/${documentId}`);
                if (response.ok) {
                    currentDocument = await response.json();
                    displayDocument(currentDocument);
                } else {
                    document.getElementById('documentDetail').innerHTML = 
                        '<div class="alert alert-error">Kh√¥ng t√¨m th·∫•y t√†i li·ªáu</div>';
                }
            } catch (error) {
                console.error('Error loading document:', error);
                document.getElementById('documentDetail').innerHTML = 
                    '<div class="alert alert-error">C√≥ l·ªói x·∫£y ra khi t·∫£i t√†i li·ªáu</div>';
            } finally {
                hideLoading();
            }
        }

        function displayDocument(doc) {
            const uploadDate = new Date(doc.ngay_tai).toLocaleDateString('vi-VN');
            const user = getUser();
            const isOwner = user && user.ma_nguoi_dung === doc.ma_nguoi_dung;

            let html = `
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h2 style="color: #2c3e50; margin-bottom: 10px;">${doc.tieu_de}</h2>
                            <div style="color: #444; font-size: 0.95rem; font-weight: 600;">
                                <span>üë§ ${doc.email || 'Anonymous'}</span> ‚Ä¢ 
                                <span>üìÖ ${uploadDate}</span> ‚Ä¢ 
                                <span>üëÅÔ∏è ${doc.so_luot_xem || 0} l∆∞·ª£t xem</span> ‚Ä¢ 
                                <span>‚¨áÔ∏è ${doc.so_luot_tai || 0} t·∫£i xu·ªëng</span>
                            </div>
                        </div>
                        ${isOwner ? `
                            <button class="btn btn-danger btn-sm" onclick="deleteDocument()">üóëÔ∏è X√≥a</button>
                        ` : ''}
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; font-weight: 700;">üìù M√¥ t·∫£</h4>
                        <p style="font-weight: 600;">${doc.mo_ta || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üìö M√¥n h·ªçc:</strong><br>
                            <span style="font-weight: 600;">${doc.ten_mon_hoc || 'N/A'}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üìÇ Danh m·ª•c:</strong><br>
                            <span style="font-weight: 600;">${doc.ten_danh_muc || 'N/A'}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <strong>üìÑ Lo·∫°i file:</strong><br>
                            <span style="font-weight: 600;">${doc.ten_tap}</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="downloadDocument()" style="flex: 1;">
                            ‚¨áÔ∏è T·∫£i xu·ªëng
                        </button>
                        <button class="btn" onclick="viewDocument()" style="flex: 1;">
                            üëÅÔ∏è Xem t√†i li·ªáu
                        </button>
                    </div>

                    <!-- Rating -->
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <h4 style="margin-bottom: 15px; font-weight: 700;">‚≠ê ƒê√°nh gi√° t√†i li·ªáu</h4>
                        <div id="ratingSection"></div>
                    </div>
                </div>
            `;

            document.getElementById('documentDetail').innerHTML = html;
            loadRating();
        }

        // ===================================
        // RATING FUNCTIONS
        // ===================================

        async function loadRating() {
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/rating`);
                if (response.ok) {
                    const data = await response.json();
                    displayRating(data);
                }
            } catch (error) {
                console.error('Error loading rating:', error);
            }
        }

        function displayRating(data) {
            const user = getUser();
            const avgRating = data.avgRating || 0;
            const totalRatings = data.totalRatings || 0;

            let html = `
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 2rem; color: #f39c12; font-weight: bold;">
                            ${avgRating.toFixed(1)} ‚≠ê
                        </div>
                        <div style="color: #444; font-size: 0.9rem; font-weight: 600;">
                            ${totalRatings} ƒë√°nh gi√°
                        </div>
                    </div>
                </div>
            `;

            if (user) {
                html += `
                    <div>
                        <p style="margin-bottom: 10px; font-weight: 600;">ƒê√°nh gi√° c·ªßa b·∫°n:</p>
                        <div style="display: flex; gap: 10px;">
                            ${[1,2,3,4,5].map(star => `
                                <button onclick="rateDocument(${star})" 
                                        style="background: none; border: none; font-size: 2rem; cursor: pointer;">
                                    ${star <= (data.userRating || 0) ? '‚≠ê' : '‚òÜ'}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                html += '<p style="color: #444; font-weight: 600;"><a href="../login.html">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ ƒë√°nh gi√° t√†i li·ªáu</p>';
            }

            document.getElementById('ratingSection').innerHTML = html;
        }

        async function rateDocument(rating) {
            const token = getToken();
            if (!token) {
                window.location.href = '../login.html';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/rate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ so_sao: rating })
                });

                if (response.ok) {
                    showToast('ƒê√°nh gi√° th√†nh c√¥ng!', 'success');
                    loadRating();
                } else {
                    showToast('Kh√¥ng th·ªÉ ƒë√°nh gi√°', 'error');
                }
            } catch (error) {
                console.error('Error rating:', error);
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }

        // ===================================
        // DOCUMENT ACTIONS
        // ===================================

        async function downloadDocument() {
            showLoading();
            try {
                const token = getToken();
                const headers = {};
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(`${API_URL}/documents/${documentId}/download`, { headers });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = currentDocument.ten_tap;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showToast('ƒêang t·∫£i xu·ªëng...', 'success');
                } else {
                    showToast('Kh√¥ng th·ªÉ t·∫£i xu·ªëng t√†i li·ªáu', 'error');
                }
            } catch (error) {
                console.error('Error downloading:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi t·∫£i xu·ªëng', 'error');
            } finally {
                hideLoading();
            }
        }

        async function viewDocument() {
            showLoading();
            try {
                const token = getToken();
                const headers = {};
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(`${API_URL}/documents/${documentId}/view`, { headers });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    window.open(url, '_blank');
                } else {
                    showToast('Kh√¥ng th·ªÉ xem t√†i li·ªáu', 'error');
                }
            } catch (error) {
                console.error('Error viewing:', error);
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteDocument() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i li·ªáu n√†y?\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;

            showLoading();

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/documents/${documentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('X√≥a th√†nh c√¥ng!', 'success');
                    setTimeout(() => {
                        window.location.href = '../sinhvien/my-documents.html';
                    }, 1500);
                } else {
                    showToast('Kh√¥ng th·ªÉ x√≥a t√†i li·ªáu', 'error');
                }
            } catch (error) {
                console.error('Error deleting:', error);
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // COMMENTS FUNCTIONS
        // ===================================

        async function loadComments() {
            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/comments`);
                if (response.ok) {
                    const comments = await response.json();
                    document.getElementById('commentCount').textContent = comments.length;
                    displayComments(comments);
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        function displayComments(comments) {
            const user = getUser();
            
            // Comment form
            if (user) {
                document.getElementById('commentFormContainer').innerHTML = `
                    <form onsubmit="submitComment(event)" style="margin: 20px 0;">
                        <textarea id="commentText" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." 
                                  style="width: 100%; padding: 12px; border: 2px solid #e9ecef; 
                                         border-radius: 8px; min-height: 80px; font-weight: 600;" required></textarea>
                        <button type="submit" class="btn" style="margin-top: 10px;">G·ª≠i b√¨nh lu·∫≠n</button>
                    </form>
                `;
            } else {
                document.getElementById('commentFormContainer').innerHTML = 
                    '<p style="color: #444; padding: 20px 0; font-weight: 600;"><a href="../login.html">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n</p>';
            }

            // Comments list
            if (comments.length === 0) {
                document.getElementById('commentsList').innerHTML = 
                    '<p style="color: #444; text-align: center; padding: 20px; font-weight: 600;">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</p>';
                return;
            }

            let html = '';
            comments.forEach(comment => {
                const commentDate = new Date(comment.ngay_tao).toLocaleDateString('vi-VN');
                const isOwner = user && user.ma_nguoi_dung === comment.ma_nguoi_dung;
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>${comment.email || 'Anonymous'}</strong>
                            <span style="color: #444; font-size: 0.9rem; font-weight: 600;">${commentDate}</span>
                        </div>
                        <p style="font-weight: 600;">${comment.noi_dung}</p>
                        ${isOwner ? `
                            <button onclick="deleteComment(${comment.ma_binh_luan})" 
                                    class="btn btn-danger btn-sm" style="margin-top: 10px;">
                                X√≥a
                            </button>
                        ` : ''}
                    </div>
                `;
            });

            document.getElementById('commentsList').innerHTML = html;
        }

        async function submitComment(event) {
            event.preventDefault();
            const text = document.getElementById('commentText').value;
            const token = getToken();

            try {
                const response = await fetch(`${API_URL}/documents/${documentId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ noi_dung: text })
                });

                if (response.ok) {
                    document.getElementById('commentText').value = '';
                    loadComments();
                    showToast('B√¨nh lu·∫≠n th√†nh c√¥ng!', 'success');
                } else {
                    showToast('Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n', 'error');
                }
            } catch (error) {
                console.error('Error submitting comment:', error);
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) return;

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadComments();
                    showToast('X√≥a b√¨nh lu·∫≠n th√†nh c√¥ng!', 'success');
                } else {
                    showToast('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n', 'error');
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================

        function getUser() {
            try {
                return JSON.parse(localStorage.getItem('user'));
            } catch (e) {
                return null;
            }
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            
            if (toast && toastMessage) {
                toastMessage.textContent = message;
                toast.className = 'notification-toast show ' + type;
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        function closeToast() {
            const toast = document.getElementById('notificationToast');
            if (toast) toast.classList.remove('show');
        }

        function toggleMobileMenu() {
            const nav = document.querySelector('.nav');
            if (nav) nav.classList.toggle('active');
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdownMenu');
            const dropdownBtn = document.querySelector('.user-dropdown-btn');
            
            if (dropdown && dropdownBtn) {
                if (!dropdown.contains(event.target) && !dropdownBtn.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                showToast('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng', 'success');
                setTimeout(() => window.location.href = '../index.html', 1000);
            }
        }
    </script>

    <!-- Chatbot Widget -->
    <script src="../chatbot-widget.js"></script>
</body>
</html>